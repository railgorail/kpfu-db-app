{{define "home.html"}}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Title }}</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        .editable-cell {
            cursor: cell;
            padding: 8px;
            transition: background-color 0.2s;
        }

        .editable-cell:hover {
            background-color: #f0f0f0;
        }

        .editable-cell:focus {
            background-color: #fff3cd;
            outline: 2px solid #ffc107;
            outline-offset: -2px;
        }

        .editable-cell.editing {
            background-color: #fff3cd;
        }

        .editable-cell.saving {
            background-color: #d1ecf1;
        }

        .editable-cell.saved {
            background-color: #d4edda;
        }

        .editable-cell.error {
            background-color: #f8d7da;
        }

        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
        }

        table {
            table-layout: auto;
        }

        .readonly-cell {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        .new-row {
            background-color: #fff3cd;
        }

        .new-row input,
        .new-row select {
            width: 100%;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="/view">View</a></li>
                <li class="nav-item"><a class="nav-link" href="/task/1">Task 1</a></li>
                <li class="nav-item"><a class="nav-link" href="/orm/task/1">ORM Task 1</a></li>
                <li class="nav-item"><a class="nav-link" href="/task/2">Task 2</a></li>
                <li class="nav-item"><a class="nav-link" href="/task/3">Task 3</a></li>
                <li class="nav-item"><a class="nav-link" href="/procedure">Procedure</a></li>
            </ul>
        </div>
    </nav>
    <div class="save-status alert alert-info" id="saveStatus"></div>
    <div class="container mt-4">

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="tableTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="warehouses-tab" data-toggle="tab" href="#warehouses" role="tab"
                    aria-controls="warehouses" aria-selected="true">Warehouses</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="contracts-tab" data-toggle="tab" href="#contracts" role="tab"
                    aria-controls="contracts" aria-selected="false">Contracts</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="deliveries-tab" data-toggle="tab" href="#deliveries" role="tab"
                    aria-controls="deliveries" aria-selected="false">Deliveries</a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content mt-3" id="tableTabContent">
            <!-- Warehouses Tab -->
            <div class="tab-pane fade show active" id="warehouses" role="tabpanel" aria-labelledby="warehouses-tab">
                <table class="table table-bordered" id="warehousesTable">
                    <thead>
                        <tr>
                            <th>Warehouse No</th>
                            <th>Manager Surname</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Warehouses}}
                        <tr data-table="warehouses" data-id="{{.WarehouseNo}}">
                            <td class="readonly-cell">{{.WarehouseNo}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="manager_surname"
                                data-original="{{.ManagerSurname}}">{{.ManagerSurname}}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteWarehouse(this)">Delete</button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                <button class="btn btn-primary" onclick="addNewWarehouse()">Add New Warehouse</button>
            </div>

            <!-- Contracts Tab -->
            <div class="tab-pane fade" id="contracts" role="tabpanel" aria-labelledby="contracts-tab">
                <table class="table table-bordered" id="contractsTable">
                    <thead>
                        <tr>
                            <th>Contract No</th>
                            <th>Part Code</th>
                            <th>Unit</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Plan Qty</th>
                            <th>Contract Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Contracts}}
                        <tr data-table="contracts" data-contract-no="{{.ContractNo}}" data-part-code="{{.PartCode}}">
                            <td class="readonly-cell">{{.ContractNo}}</td>
                            <td class="readonly-cell">{{.PartCode}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="unit"
                                data-original="{{.Unit}}">
                                {{.Unit}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="start_date"
                                data-original="{{.StartDate.Format " 2006-01-02"}}" data-type="date">{{.StartDate.Format
                                "2006-01-02"}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="end_date"
                                data-original="{{.EndDate.Format " 2006-01-02"}}" data-type="date">{{.EndDate.Format
                                "2006-01-02"}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="plan_qty"
                                data-original="{{.PlanQty}}" data-type="number">{{.PlanQty}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="contract_price"
                                data-original="{{.ContractPrice}}" data-type="number">{{.ContractPrice}}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteContract(this)">Delete</button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                <button class="btn btn-primary" onclick="addNewContract()">Add New Contract</button>
            </div>

            <!-- Deliveries Tab -->
            <div class="tab-pane fade" id="deliveries" role="tabpanel" aria-labelledby="deliveries-tab">
                <table class="table table-bordered" id="deliveriesTable">
                    <thead>
                        <tr>
                            <th>Warehouse No</th>
                            <th>Receipt Doc No</th>
                            <th>Contract No</th>
                            <th>Part Code</th>
                            <th>Unit</th>
                            <th>Qty</th>
                            <th>Received Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Deliveries}}
                        <tr data-table="deliveries" data-warehouse-no="{{.WarehouseNo}}"
                            data-receipt-doc-no="{{.ReceiptDocNo}}">
                            <td class="readonly-cell">{{.WarehouseNo}}</td>
                            <td class="readonly-cell">{{.ReceiptDocNo}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="contract_no"
                                data-original="{{.ContractNo}}" data-type="number">{{.ContractNo}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="part_code"
                                data-original="{{.PartCode}}">{{.PartCode}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="unit"
                                data-original="{{.Unit}}">
                                {{.Unit}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="qty" data-original="{{.Qty}}"
                                data-type="number">{{.Qty}}</td>
                            <td class="editable-cell" contenteditable="true" data-field="received_date"
                                data-original="{{.ReceivedDate.Format " 2006-01-02"}}" data-type="date">
                                {{.ReceivedDate.Format
                                "2006-01-02"}}</td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="deleteDelivery(this)">Delete</button>
                            </td>
                        </tr>
                        {{end}}
                    </tbody>
                </table>
                <button class="btn btn-primary" onclick="addNewDelivery()">Add New Delivery</button>
            </div>
        </div>
    </div>
    
    <div class="container mt-4">
        <h6>source: <a href="https://github.com/railgorail/kpfu-db-app">https://github.com/railgorail/kpfu-db-app</a></h6>
        <img src="/static/zall.png" alt="zall" width="800">
    </div>
    <script>
        (function () {
            let saveTimeout = null;
            const saveStatus = document.getElementById('saveStatus');

            function showStatus(message, type = 'info') {
                saveStatus.className = `save-status alert alert-${type}`;
                saveStatus.textContent = message;
                saveStatus.style.display = 'block';
                setTimeout(() => {
                    saveStatus.style.display = 'none';
                }, 3000);
            }

            function getRowData(row) {
                const table = row.dataset.table;
                const data = { table };

                if (table === 'warehouses') {
                    data.id = parseInt(row.dataset.id);
                } else if (table === 'contracts') {
                    data.contract_no = parseInt(row.dataset.contractNo);
                    data.part_code = row.dataset.partCode;
                } else if (table === 'deliveries') {
                    data.warehouse_no = parseInt(row.dataset.warehouseNo);
                    data.receipt_doc_no = parseInt(row.dataset.receiptDocNo);
                }

                const cells = row.querySelectorAll('.editable-cell');
                cells.forEach(cell => {
                    const field = cell.dataset.field;
                    let value = cell.textContent.trim();

                    if (cell.dataset.type === 'number') {
                        value = parseFloat(value);
                    } else if (cell.dataset.type === 'date') {
                        // Keep date as string, backend will parse it
                    }

                    data[field] = value;
                });

                return data;
            }

            async function saveRow(row) {
                const cell = row.querySelector('.editable-cell.editing');
                if (!cell) return;

                cell.classList.remove('editing');
                cell.classList.add('saving');

                const data = getRowData(row);
                const table = data.table;
                delete data.table;

                try {
                    const response = await fetch(`/api/${table}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || 'Failed to save');
                    }

                    cell.classList.remove('saving');
                    cell.classList.add('saved');
                    cell.dataset.original = cell.textContent.trim();

                    setTimeout(() => {
                        cell.classList.remove('saved');
                    }, 1000);

                    showStatus('Changes saved successfully', 'success');
                } catch (error) {
                    cell.classList.remove('saving');
                    cell.classList.add('error');
                    showStatus('Error saving: ' + error.message, 'danger');

                    // Revert to original value
                    setTimeout(() => {
                        cell.textContent = cell.dataset.original;
                        cell.classList.remove('error');
                    }, 2000);
                }
            }

            // Handle cell editing
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('focus', function () {
                    this.classList.add('editing');
                    this.dataset.original = this.textContent.trim();
                });

                cell.addEventListener('blur', function () {
                    const row = this.closest('tr');
                    if (this.textContent.trim() !== this.dataset.original) {
                        if (saveTimeout) {
                            clearTimeout(saveTimeout);
                        }
                        saveTimeout = setTimeout(() => saveRow(row), 500);
                    } else {
                        this.classList.remove('editing');
                    }
                });

                cell.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    } else if (e.key === 'Escape') {
                        this.textContent = this.dataset.original;
                        this.blur();
                    }
                });
            });

            // Handle paste events
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('paste', function (e) {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text');
                    this.textContent = text;
                });
            });

            // Add new warehouse row
            window.addNewWarehouse = function () {
                const tbody = document.querySelector('#warehousesTable tbody');
                const row = document.createElement('tr');
                row.className = 'new-row';
                row.innerHTML = `
                    <td><em>New</em></td>
                    <td><input type="text" class="new-manager-surname" placeholder="Manager Surname" required></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="saveNewWarehouse(this)">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelNewRow(this)">Cancel</button>
                    </td>
                `;
                tbody.appendChild(row);
                row.querySelector('.new-manager-surname').focus();
            };

            // Add new contract row
            window.addNewContract = function () {
                const tbody = document.querySelector('#contractsTable tbody');
                const row = document.createElement('tr');
                row.className = 'new-row';
                const today = new Date().toISOString().split('T')[0];
                row.innerHTML = `
                    <td><input type="number" class="new-contract-no" placeholder="Contract No" required></td>
                    <td><input type="text" class="new-part-code" placeholder="Part Code" required></td>
                    <td>
                        <select class="new-unit" required>
                            <option value="">Select unit</option>
                            <option value="pcs">pcs</option>
                            <option value="kg">kg</option>
                            <option value="m">m</option>
                            <option value="set">set</option>
                        </select>
                    </td>
                    <td><input type="date" class="new-start-date" required></td>
                    <td><input type="date" class="new-end-date" required></td>
                    <td><input type="number" step="0.01" class="new-plan-qty" placeholder="Plan Qty" required></td>
                    <td><input type="number" step="0.01" class="new-contract-price" placeholder="Price" required></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="saveNewContract(this)">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelNewRow(this)">Cancel</button>
                    </td>
                `;
                tbody.appendChild(row);
                row.querySelector('.new-contract-no').focus();
            };

            // Add new delivery row
            window.addNewDelivery = function () {
                const tbody = document.querySelector('#deliveriesTable tbody');
                const row = document.createElement('tr');
                row.className = 'new-row';
                const today = new Date().toISOString().split('T')[0];
                row.innerHTML = `
                    <td><input type="number" class="new-warehouse-no" placeholder="Warehouse No" required></td>
                    <td><input type="number" class="new-receipt-doc-no" placeholder="Receipt Doc No" required></td>
                    <td><input type="number" class="new-contract-no" placeholder="Contract No" required></td>
                    <td><input type="text" class="new-part-code" placeholder="Part Code" required></td>
                    <td>
                        <select class="new-unit" required>
                            <option value="">Select unit</option>
                            <option value="pcs">pcs</option>
                            <option value="kg">kg</option>
                            <option value="m">m</option>
                            <option value="set">set</option>
                        </select>
                    </td>
                    <td><input type="number" step="0.01" class="new-qty" placeholder="Qty" required></td>
                    <td><input type="date" class="new-received-date" value="${today}" required></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="saveNewDelivery(this)">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelNewRow(this)">Cancel</button>
                    </td>
                `;
                tbody.appendChild(row);
                row.querySelector('.new-warehouse-no').focus();
            };

            // Cancel new row
            window.cancelNewRow = function (button) {
                const row = button.closest('tr');
                row.remove();
            };

            // Save new warehouse
            window.saveNewWarehouse = async function (button) {
                const row = button.closest('tr');
                const managerSurname = row.querySelector('.new-manager-surname').value.trim();

                if (!managerSurname) {
                    showStatus('Manager surname is required', 'danger');
                    return;
                }

                button.disabled = true;
                button.textContent = 'Saving...';

                try {
                    const response = await fetch('/api/warehouses', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ manager_surname: managerSurname })
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || 'Failed to create warehouse');
                    }

                    const result = await response.json();
                    showStatus('Warehouse created successfully', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } catch (error) {
                    showStatus('Error creating warehouse: ' + error.message, 'danger');
                    button.disabled = false;
                    button.textContent = 'Save';
                }
            };

            // Save new contract
            window.saveNewContract = async function (button) {
                const row = button.closest('tr');
                const data = {
                    contract_no: parseInt(row.querySelector('.new-contract-no').value),
                    part_code: row.querySelector('.new-part-code').value.trim(),
                    unit: row.querySelector('.new-unit').value,
                    start_date: row.querySelector('.new-start-date').value,
                    end_date: row.querySelector('.new-end-date').value,
                    plan_qty: parseFloat(row.querySelector('.new-plan-qty').value),
                    contract_price: parseFloat(row.querySelector('.new-contract-price').value)
                };

                if (!data.contract_no || !data.part_code || !data.unit || !data.start_date ||
                    !data.end_date || !data.plan_qty || !data.contract_price) {
                    showStatus('All fields are required', 'danger');
                    return;
                }

                button.disabled = true;
                button.textContent = 'Saving...';

                try {
                    const response = await fetch('/api/contracts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || 'Failed to create contract');
                    }

                    showStatus('Contract created successfully', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } catch (error) {
                    showStatus('Error creating contract: ' + error.message, 'danger');
                    button.disabled = false;
                    button.textContent = 'Save';
                }
            };

            // Save new delivery
            window.saveNewDelivery = async function (button) {
                const row = button.closest('tr');
                const data = {
                    warehouse_no: parseInt(row.querySelector('.new-warehouse-no').value),
                    receipt_doc_no: parseInt(row.querySelector('.new-receipt-doc-no').value),
                    contract_no: parseInt(row.querySelector('.new-contract-no').value),
                    part_code: row.querySelector('.new-part-code').value.trim(),
                    unit: row.querySelector('.new-unit').value,
                    qty: parseFloat(row.querySelector('.new-qty').value),
                    received_date: row.querySelector('.new-received-date').value
                };

                if (!data.warehouse_no || !data.receipt_doc_no || !data.contract_no || !data.part_code ||
                    !data.unit || !data.qty || !data.received_date) {
                    showStatus('All fields are required', 'danger');
                    return;
                }

                button.disabled = true;
                button.textContent = 'Saving...';

                try {
                    const response = await fetch('/api/deliveries', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || 'Failed to create delivery');
                    }

                    showStatus('Delivery created successfully', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } catch (error) {
                    showStatus('Error creating delivery: ' + error.message, 'danger');
                    button.disabled = false;
                    button.textContent = 'Save';
                }
            };
        })();
    </script>
    <script>
        (function () {
            let saveTimeout = null;
            const saveStatus = document.getElementById('saveStatus');

            function showStatus(message, type = 'info') {
                saveStatus.className = `save-status alert alert-${type}`;
                saveStatus.textContent = message;
                saveStatus.style.display = 'block';
                setTimeout(() => {
                    saveStatus.style.display = 'none';
                }, 3000);
            }

            function getRowData(row) {
                const table = row.dataset.table;
                const data = { table };

                if (table === 'warehouses') {
                    data.id = parseInt(row.dataset.id);
                } else if (table === 'contracts') {
                    data.contract_no = parseInt(row.dataset.contractNo);
                    data.part_code = row.dataset.partCode;
                } else if (table === 'deliveries') {
                    data.warehouse_no = parseInt(row.dataset.warehouseNo);
                    data.receipt_doc_no = parseInt(row.dataset.receiptDocNo);
                }

                const cells = row.querySelectorAll('.editable-cell');
                cells.forEach(cell => {
                    const field = cell.dataset.field;
                    let value = cell.textContent.trim();

                    if (cell.dataset.type === 'number') {
                        value = parseFloat(value);
                    } else if (cell.dataset.type === 'date') {
                        // Keep date as string, backend will parse it
                    }

                    data[field] = value;
                });

                return data;
            }

            async function saveRow(row) {
                const cell = row.querySelector('.editable-cell.editing');
                if (!cell) return;

                cell.classList.remove('editing');
                cell.classList.add('saving');

                const data = getRowData(row);
                const table = data.table;
                delete data.table;

                try {
                    const response = await fetch(`/api/${table}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || 'Failed to save');
                    }

                    cell.classList.remove('saving');
                    cell.classList.add('saved');
                    cell.dataset.original = cell.textContent.trim();

                    setTimeout(() => {
                        cell.classList.remove('saved');
                    }, 1000);

                    showStatus('Changes saved successfully', 'success');
                } catch (error) {
                    cell.classList.remove('saving');
                    cell.classList.add('error');
                    showStatus('Error saving: ' + error.message, 'danger');

                    // Revert to original value
                    setTimeout(() => {
                        cell.textContent = cell.dataset.original;
                        cell.classList.remove('error');
                    }, 2000);
                }
            }

            // Handle cell editing
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('focus', function () {
                    this.classList.add('editing');
                    this.dataset.original = this.textContent.trim();
                });

                cell.addEventListener('blur', function () {
                    const row = this.closest('tr');
                    if (this.textContent.trim() !== this.dataset.original) {
                        if (saveTimeout) {
                            clearTimeout(saveTimeout);
                        }
                        saveTimeout = setTimeout(() => saveRow(row), 500);
                    } else {
                        this.classList.remove('editing');
                    }
                });

                cell.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.blur();
                    } else if (e.key === 'Escape') {
                        this.textContent = this.dataset.original;
                        this.blur();
                    }
                });
            });

            // Handle paste events
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.addEventListener('paste', function (e) {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text');
                    this.textContent = text;
                });
            });

            // Add new warehouse row
            window.addNewWarehouse = function () {
                const tbody = document.querySelector('#warehousesTable tbody');
                const row = document.createElement('tr');
                row.className = 'new-row';
                row.innerHTML = `
                    <td><em>New</em></td>
                    <td><input type="text" class="new-manager-surname" placeholder="Manager Surname" required></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="saveNewWarehouse(this)">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelNewRow(this)">Cancel</button>
                    </td>
                `;
                tbody.appendChild(row);
                row.querySelector('.new-manager-surname').focus();
            };

            // Add new contract row
            window.addNewContract = function () {
                const tbody = document.querySelector('#contractsTable tbody');
                const row = document.createElement('tr');
                row.className = 'new-row';
                const today = new Date().toISOString().split('T')[0];
                row.innerHTML = `
                    <td><input type="number" class="new-contract-no" placeholder="Contract No" required></td>
                    <td><input type="text" class="new-part-code" placeholder="Part Code" required></td>
                    <td>
                        <select class="new-unit" required>
                            <option value="">Select unit</option>
                            <option value="pcs">pcs</option>
                            <option value="kg">kg</option>
                            <option value="m">m</option>
                            <option value="set">set</option>
                        </select>
                    </td>
                    <td><input type="date" class="new-start-date" required></td>
                    <td><input type="date" class="new-end-date" required></td>
                    <td><input type="number" step="0.01" class="new-plan-qty" placeholder="Plan Qty" required></td>
                    <td><input type="number" step="0.01" class="new-contract-price" placeholder="Price" required></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="saveNewContract(this)">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelNewRow(this)">Cancel</button>
                    </td>
                `;
                tbody.appendChild(row);
                row.querySelector('.new-contract-no').focus();
            };

            // Add new delivery row
            window.addNewDelivery = function () {
                const tbody = document.querySelector('#deliveriesTable tbody');
                const row = document.createElement('tr');
                row.className = 'new-row';
                const today = new Date().toISOString().split('T')[0];
                row.innerHTML = `
                    <td><input type="number" class="new-warehouse-no" placeholder="Warehouse No" required></td>
                    <td><input type="number" class="new-receipt-doc-no" placeholder="Receipt Doc No" required></td>
                    <td><input type="number" class="new-contract-no" placeholder="Contract No" required></td>
                    <td><input type="text" class="new-part-code" placeholder="Part Code" required></td>
                    <td>
                        <select class="new-unit" required>
                            <option value="">Select unit</option>
                            <option value="pcs">pcs</option>
                            <option value="kg">kg</option>
                            <option value="m">m</option>
                            <option value="set">set</option>
                        </select>
                    </td>
                    <td><input type="number" step="0.01" class="new-qty" placeholder="Qty" required></td>
                    <td><input type="date" class="new-received-date" value="${today}" required></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="saveNewDelivery(this)">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelNewRow(this)">Cancel</button>
                    </td>
                `;
                tbody.appendChild(row);
                row.querySelector('.new-warehouse-no').focus();
            };

            // Cancel new row
            window.cancelNewRow = function (button) {
                const row = button.closest('tr');
                row.remove();
            };

            // Save new warehouse
            window.saveNewWarehouse = async function (button) {
                const row = button.closest('tr');
                const managerSurname = row.querySelector('.new-manager-surname').value.trim();

                if (!managerSurname) {
                    showStatus('Manager surname is required', 'danger');
                    return;
                }

                button.disabled = true;
                button.textContent = 'Saving...';

                try {
                    const response = await fetch('/api/warehouses', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ manager_surname: managerSurname })
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || 'Failed to create warehouse');
                    }

                    const result = await response.json();
                    showStatus('Warehouse created successfully', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } catch (error) {
                    showStatus('Error creating warehouse: ' + error.message, 'danger');
                    button.disabled = false;
                    button.textContent = 'Save';
                }
            };

            // Save new contract
            window.saveNewContract = async function (button) {
                const row = button.closest('tr');
                const data = {
                    contract_no: parseInt(row.querySelector('.new-contract-no').value),
                    part_code: row.querySelector('.new-part-code').value.trim(),
                    unit: row.querySelector('.new-unit').value,
                    start_date: row.querySelector('.new-start-date').value,
                    end_date: row.querySelector('.new-end-date').value,
                    plan_qty: parseFloat(row.querySelector('.new-plan-qty').value),
                    contract_price: parseFloat(row.querySelector('.new-contract-price').value)
                };

                if (!data.contract_no || !data.part_code || !data.unit || !data.start_date ||
                    !data.end_date || !data.plan_qty || !data.contract_price) {
                    showStatus('All fields are required', 'danger');
                    return;
                }

                button.disabled = true;
                button.textContent = 'Saving...';

                try {
                    const response = await fetch('/api/contracts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || 'Failed to create contract');
                    }

                    showStatus('Contract created successfully', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } catch (error) {
                    showStatus('Error creating contract: ' + error.message, 'danger');
                    button.disabled = false;
                    button.textContent = 'Save';
                }
            };

            // Save new delivery
            window.saveNewDelivery = async function (button) {
                const row = button.closest('tr');
                const data = {
                    warehouse_no: parseInt(row.querySelector('.new-warehouse-no').value),
                    receipt_doc_no: parseInt(row.querySelector('.new-receipt-doc-no').value),
                    contract_no: parseInt(row.querySelector('.new-contract-no').value),
                    part_code: row.querySelector('.new-part-code').value.trim(),
                    unit: row.querySelector('.new-unit').value,
                    qty: parseFloat(row.querySelector('.new-qty').value),
                    received_date: row.querySelector('.new-received-date').value
                };

                if (!data.warehouse_no || !data.receipt_doc_no || !data.contract_no || !data.part_code ||
                    !data.unit || !data.qty || !data.received_date) {
                    showStatus('All fields are required', 'danger');
                    return;
                }

                button.disabled = true;
                button.textContent = 'Saving...';

                try {
                    const response = await fetch('/api/deliveries', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        throw new Error(error || 'Failed to create delivery');
                    }

                    showStatus('Delivery created successfully', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } catch (error) {
                    showStatus('Error creating delivery: ' + error.message, 'danger');
                    button.disabled = false;
                    button.textContent = 'Save';
                }
            };

            window.deleteWarehouse = async function (btn) {
                const row = btn.closest('tr');
                const id = row.dataset.id;
                btn.disabled = true;
                btn.textContent = 'Deleting...';
                try {
                    const response = await fetch(`/api/warehouses`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: parseInt(id) })
                    });
                    if (!response.ok) throw new Error(await response.text() || 'Delete failed');
                    showStatus('Deleted successfully', 'success');
                    row.remove();
                    location.reload();
                } catch (error) {
                    showStatus('Error deleting: ' + error.message, 'danger');
                    btn.disabled = false;
                    btn.textContent = 'Delete';
                }
            };
            window.deleteContract = async function (btn) {
                const row = btn.closest('tr');
                const contractNo = row.dataset.contractNo;
                const partCode = row.dataset.partCode;
                btn.disabled = true;
                btn.textContent = 'Deleting...';
                try {
                    const response = await fetch(`/api/contracts`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contract_no: parseInt(contractNo), part_code: partCode })
                    });
                    if (!response.ok) throw new Error(await response.text() || 'Delete failed');
                    showStatus('Deleted successfully', 'success');
                    row.remove();
                    location.reload();
                } catch (error) {
                    showStatus('Error deleting: ' + error.message, 'danger');
                    btn.disabled = false;
                    btn.textContent = 'Delete';
                }
            };
            window.deleteDelivery = async function (btn) {
                const row = btn.closest('tr');
                const warehouseNo = row.dataset.warehouseNo;
                const receiptDocNo = row.dataset.receiptDocNo;
                btn.disabled = true;
                btn.textContent = 'Deleting...';
                try {
                    const response = await fetch(`/api/deliveries`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ warehouse_no: parseInt(warehouseNo), receipt_doc_no: parseInt(receiptDocNo) })
                    });
                    if (!response.ok) throw new Error(await response.text() || 'Delete failed');
                    showStatus('Deleted successfully', 'success');
                    row.remove();
                    location.reload();
                } catch (error) {
                    showStatus('Error deleting: ' + error.message, 'danger');
                    btn.disabled = false;
                    btn.textContent = 'Delete';
                }
            };
        })();
    </script>
</body>

</html>
{{end}}